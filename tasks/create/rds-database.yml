---
- name: Create Database Subnet Group
  rds_subnet_group:
    state: present
    name: "{{ project }}-{{ role }}"
    description: "Database for {{ project }}"
    region: "{{ region }}"
    subnets: "{{ vpc.subnets | selectattr('resource_tags.Role', 'equalto', role) | map(attribute='id') | list }}"

- name: Create Database Servers
  rds:

    command: create

    region: "{{ region }}"
    multi_zone: yes

    instance_name: "{{ project }}-{{ role }}-{{ environment_tier }}"
    instance_type: "{{ database.instance_type | mandatory }}"

    vpc_security_groups: "{{ security_group_id[role] }}"
    subnet: "{{ project }}-{{ role }}"

    db_engine: "{{ db_engine | mandatory }}"
    upgrade: yes

    port: "{% if db_engine == 'postgres' %}5432{%elif db_engine == 'mysql' %}3306{% endif %}"
    db_name: "{{ database.name | default(project) }}"
    username: "{{ database.username | default(project) }}"
    password: "{{ database.password | mandatory }}"

    backup_retention: 30
    size: 100
    wait: yes
